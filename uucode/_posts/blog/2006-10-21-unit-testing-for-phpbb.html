---
layout: post
title: Unit testing for phpBB
date: 2006-10-21 08:43:51.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- PHP
tags: []
meta: {}
author:
  login: olpa
  email: olpa@uucode.com
  display_name: olpa
  first_name: Oleg
  last_name: Paraschenko
permalink: "/blog/2006/10/21/unit-testing-for-phpbb/"
---
<p>I was writing a MOD for phpBB, and at some moment I found I can't go further without unit testing. I found it's quite a hard task because phpBB is written without testing in mind. However, unit testing for phpBB is possible.</p>
<p><!--more--></p>
<p>The beginning of a test file consists of two parts:</p>
<p>* loading SimpleTest stuff, and<br />
* loading phpBB stuff.</p>
<pre style="color:#000000;background:#ffffff;"><code><span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">// SimpleTest</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#400000; background:#ffffe8; ">define</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'TEST'</span><span style="color:#808030; background:#ffffe8; ">,</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">__FILE__</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#400000; background:#ffffe8; ">define</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'SIMPLE_TEST'</span><span style="color:#808030; background:#ffffe8; ">,</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#400000; background:#ffffe8; ">dirname</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">TEST</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">'/simpletest'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">SIMPLE_TEST </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">'/unit_tester.php'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">SIMPLE_TEST </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">'/reporter.php'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">// phpBB</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#400000; background:#ffffe8; ">define</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'PHPBB_PATH'</span><span style="color:#808030; background:#ffffe8; ">,</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#400000; background:#ffffe8; ">dirname</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">TEST</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">'/../phpBB2'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#400000; background:#ffffe8; ">ini_set</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'include_path'</span><span style="color:#808030; background:#ffffe8; ">,</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">'.:'</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> PHPBB_PATH </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">':'</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#400000; background:#ffffe8; ">ini_get</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'include_path'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#400000; background:#ffffe8; ">define</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'IN_PHPBB'</span><span style="color:#808030; background:#ffffe8; ">,</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#008c00; background:#ffffe8; ">1</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'extension.inc'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'common.php'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'includes/functions_tc.php'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
</code></pre>
<p>The first step is to get the path to the phpBB installation. The path is hardcoded.</p>
<p>The next step is to define the include path. The code adds the phpBB path to the include path and, what's more important, adds the current directory before everything else. It helps to hijack loading of a phpBB file and substitute it with a special version of the file.</p>
<p>The most of the phpBB files loads, explicitely or not, "<tt>extension.inc</tt>" and "<tt>common.php</tt>". Before loading them, the constant "<tt>IN_PHPBB</tt>" should be defined, otherwise you'll get the "hacking attempt" error.</p>
<p>Finally, I load my file "<tt>includes/functions_tc.php</tt>" to test its functions.</p>
<p>What's behind the scene is the mock file "<tt>includes/db.php</tt>", which is loaded by phpBB instead of the orignial "<tt>includes/db.php</tt>", thanks to the carefully set include paths. Here is the current version of the file:</p>
<pre style="color:#000000;background:#ffffff;"><code><span style="color:#a65700; background:#ffffe8; ">&lt;?php</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">// Mock database object</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#696969; background:#ffffe8; ">//</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">class</span><span style="color:#000000; background:#ffffe8; "> db_mock </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">var</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$data</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> db_mock</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">$data</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#000000; background:#ffffe8; ">$</span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">this</span><span style="color:#808030; background:#ffffe8; ">-></span><span style="color:#000000; background:#ffffe8; ">data</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$data</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_query</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">return</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#008c00; background:#ffffe8; ">1</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_fetchrow</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">return</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#008c00; background:#ffffe8; ">0</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_fetchrowset</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#400000; background:#ffffe8; ">reset</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">$</span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">this</span><span style="color:#808030; background:#ffffe8; ">-></span><span style="color:#000000; background:#ffffe8; ">data</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">return</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$</span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">this</span><span style="color:#808030; background:#ffffe8; ">-></span><span style="color:#000000; background:#ffffe8; ">data</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_freeresult</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_affectedrows</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">return</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#008c00; background:#ffffe8; ">0</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">function</span><span style="color:#000000; background:#ffffe8; "> sql_error</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#000000; background:#ffffe8; ">$a</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#400000; background:#ffffe8; ">debug_backtrace</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#400000; background:#ffffe8; ">var_dump</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">$a</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#000000; background:#ffffe8; ">$s</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">''</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">foreach</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">$a</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">as</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$item</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">      </span><span style="color:#000000; background:#ffffe8; ">$s2</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">"--</span><span style="color:#0f69ff; background:#ffffe8; ">\n</span><span style="color:#0000e6; background:#ffffe8; ">"</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">      </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">foreach</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#000000; background:#ffffe8; ">$item</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">as</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$k</span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#808030; background:#ffffe8; ">></span><span style="color:#000000; background:#ffffe8; ">$v</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800080; background:#ffffe8; ">{</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">        </span><span style="color:#000000; background:#ffffe8; ">$s2</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">"</span><span style="color:#0000e6; background:#ffffe8; ">$k</span><span style="color:#0000e6; background:#ffffe8; "> = </span><span style="color:#0000e6; background:#ffffe8; ">$v</span><span style="color:#0f69ff; background:#ffffe8; ">\n</span><span style="color:#0000e6; background:#ffffe8; ">"</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">      </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">      </span><span style="color:#000000; background:#ffffe8; ">$s</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$s2</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#000000; background:#ffffe8; ">$s</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">.</span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#0000e6; background:#ffffe8; ">"--</span><span style="color:#0f69ff; background:#ffffe8; ">\n</span><span style="color:#0000e6; background:#ffffe8; ">"</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">    </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">return</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#000000; background:#ffffe8; ">$s</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">  </span><span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800080; background:#ffffe8; ">}</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">$db</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">new</span><span style="color:#000000; background:#ffffe8; "> db_mock</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">array</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#a65700; background:#ffffe8; ">?></span>
</code></pre>
<p>An object of this class just returns the data you want, all other methods are just stubs to do nothing.</p>
<p>Normally, the call to <tt>sql_error</tt> shouldn't happen. However, it happens, mostly when the developer of tests overlooked something. To help find the error, I convert the stack trace to a string and return it. Unfortunately, this string is lost in the phpBB debrees, therefore I use <tt>var_dump</tt> to print the trace to the console. Returning the string isn't needed anymore, but I left it as a legacy code :-)</p>
<p>Testing admin scripts requires yet another trick. Before loading them, add something like:</p>
<pre style="color:#000000;background:#ffffff;"><code><span style="color:#000000; background:#ffffe8; ">$setmodules</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#008c00; background:#ffffe8; ">1</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#000000; background:#ffffe8; ">$module</span><span style="color:#000000; background:#ffffe8; ">     </span><span style="color:#808030; background:#ffffe8; ">=</span><span style="color:#000000; background:#ffffe8; "> </span><span style="color:#800000; background:#ffffe8; font-weight:bold; ">array</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
<span style="color:#800000; background:#ffffe8; font-weight:bold; ">require_once</span><span style="color:#808030; background:#ffffe8; ">(</span><span style="color:#0000e6; background:#ffffe8; ">'admin/admin_tc.php'</span><span style="color:#808030; background:#ffffe8; ">)</span><span style="color:#800080; background:#ffffe8; ">;</span><span style="color:#000000; background:#ffffe8; "></span>
</code></pre>
<p>The admin script decides that it's started by the information collector, therefore the script updates the array <tt>$module</tt> and exits immediately. But thanks to the PHP features, all the functions, defined in the script file, are now available.</p>
<p>Well, does all this stuff worth the efforts? Yes.</p>
<p>* After I had written the tests, I found 3 errors in my good code, and one error was serious.<br />
* I can modify the code without being afraid to break something.<br />
* I can test the code without clicking and typing in browser, and without repeating everything each time after new changes.<br />
* It have saved me a lot of time and efforts.</p>
